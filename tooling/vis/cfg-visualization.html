<html>
    <head>
        <title>CFG Visualization</title>
        <link rel="stylesheet" type="text/css" href="../../vendor/stylesheets/bootstrap.min.css">
        <link rel="stylesheet" type="text/css" href="style.css">                      
    </head>    
    <body>
        <div class="container">
            <h1>Control Flow Graph Visualization</h1>
            
            <div class="col-md-9">
                <textarea id="input" autofocus="autofocus" class="form-control code-input" rows="8"></textarea>
            </div>
            
            <div class="col-md-3">
                <div class="well">
                    <p>
                        <strong>Optimization Passes</strong>
                    </p>
                    
                    <div class="checkbox">
                        <label for="transit-node-removal-pass">
                            <input type="checkbox" id="transit-node-removal-pass" checked />
                            Remove transit nodes
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="col-md-12">
                <div id="graph"></div>
            </div>
        </div>

        <script type="text/javascript" src="../../vendor/jquery.min.js"></script>
        <script type="text/javascript" src="../../vendor/lodash.js"></script>
        <script type="text/javascript" src="../../vendor/esprima.js"></script>
        <script type="text/javascript" src="../../vendor/vis.min.js"></script>
        <script type="text/javascript" src="../../dist/styx.js"></script>
        <script type="text/javascript" src="cfg-visualization.js"></script>

        <script type="text/javascript">
            (function() {
                var container = document.getElementById("graph");
                var $input = $("#input");
                var $removeTransitNodesCheckbox = $("#transit-node-removal-pass");
                var previousCode;
                
                var update = function() {
                    var code = $input.val();
                    
                    if (code === previousCode) {
                        return;
                    }
                    
                    var options = {
                        passes: {
                            removeTransitNodes: $removeTransitNodesCheckbox.is(":checked")
                        }
                    };
                    
                    previousCode = code;
                    sessionStorage.setItem("code", code);
                    
                    window.cfgVisualization.renderControlFlowGraph(container, code, options);
                };
                
                var debouncedUpdate = _.debounce(update, 200);
                
                $input.on("keydown", keydown);
                $input.on("keyup", debouncedUpdate);
                
                function keydown(e) {
                    if (e.keyCode === 9 /* tab */) {
                        e.preventDefault();
                        
                        var cursorPos = $input.prop("selectionStart");
                        var input = $input.val();
                        var textBefore = input.substring(0, cursorPos);
                        var textAfter  = input.substring(cursorPos, input.length);
                        
                        $input.val(textBefore + "    " + textAfter);
                        $input.setCaretPosition(cursorPos + 4);
                    }
                }
                
                $input.val(sessionStorage.getItem("code"));
                update();
                
                $.fn.setCaretPosition = function(position) {
                    return this.each(function() {
                        if (this.setSelectionRange) {
                            this.focus();
                            this.setSelectionRange(position, position);
                        } else if (this.createTextRange) {
                            var range = this.createTextRange();
                            range.collapse(true);
                            range.moveEnd("character", position);
                            range.moveStart("character", position);
                            range.select();
                        }
                    });
                };
            }());            
        </script>
    </body>
</html>
